version: '3.8'

services:
  # SOAR Automation Service
  soar:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: banking-soar-automation
    hostname: soar
    restart: unless-stopped
    
    ports:
      - "8200:8200"  # API
      - "8201:8201"  # Metrics
      - "9092:9092"  # Messaging
    
    environment:
      # Service configuration
      - SOAR_ENV=production
      - SOAR_LOG_LEVEL=INFO
      
      # OpenSearch
      - OPENSEARCH_HOSTS=https://wazuh.indexer:9200
      - OPENSEARCH_SOAR_USERNAME=soar
      - OPENSEARCH_SOAR_PASSWORD=${OPENSEARCH_SOAR_PASSWORD}
      
      # Redis
      - REDIS_HOST=soar-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      
      # PostgreSQL
      - POSTGRES_HOST=soar-postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=banking_soar
      - POSTGRES_USERNAME=soar
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      
      # RabbitMQ
      - RABBITMQ_HOST=soar-rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=soar
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=/soar
      
      # External integrations
      - WAZUH_API_URL=https://wazuh.manager:55000
      - WAZUH_API_USERNAME=${WAZUH_API_USERNAME}
      - WAZUH_API_PASSWORD=${WAZUH_API_PASSWORD}
      
      # Encrypted credentials (decrypt on startup)
      - SSH_SUDO_PASSWORD_ENC=${SSH_SUDO_PASSWORD_ENC}
      - WINRM_PASSWORD_ENC=${WINRM_PASSWORD_ENC}
      - AD_BIND_PASSWORD_ENC=${AD_BIND_PASSWORD_ENC}
      - FIREWALL_API_KEY_ENC=${FIREWALL_API_KEY_ENC}
      - CROWDSTRIKE_SECRET_ENC=${CROWDSTRIKE_SECRET_ENC}
      - AWS_SECRET_ACCESS_KEY_ENC=${AWS_SECRET_ACCESS_KEY_ENC}
      - AZURE_CLIENT_SECRET_ENC=${AZURE_CLIENT_SECRET_ENC}
      
      # Notification services
      - SLACK_WEBHOOK_URL_ENC=${SLACK_WEBHOOK_URL_ENC}
      - SLACK_BOT_TOKEN_ENC=${SLACK_BOT_TOKEN_ENC}
      - SMTP_PASSWORD_ENC=${SMTP_PASSWORD_ENC}
      - TWILIO_AUTH_TOKEN_ENC=${TWILIO_AUTH_TOKEN_ENC}
      - PAGERDUTY_API_KEY_ENC=${PAGERDUTY_API_KEY_ENC}
      
      # Security
      - JWT_SECRET=${JWT_SECRET}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
    
    volumes:
      - ./config:/app/config:ro
      - ./playbooks:/app/playbooks:rw
      - ./keys:/app/keys:ro
      - soar-audit-logs:/var/log/soar
      - opensearch-certs:/app/certs:ro
    
    networks:
      - soc-soar-network
      - soc-analytics-network
    
    depends_on:
      soar-postgres:
        condition: service_healthy
      soar-redis:
        condition: service_healthy
      soar-rabbitmq:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service=soar,environment=production"

  # PostgreSQL for incident state and audit
  soar-postgres:
    image: postgres:15-alpine
    container_name: banking-soar-postgres
    hostname: soar-postgres
    restart: unless-stopped
    
    environment:
      - POSTGRES_DB=banking_soar
      - POSTGRES_USER=soar
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
      - PGDATA=/var/lib/postgresql/data/pgdata
    
    volumes:
      - soar-postgres-data:/var/lib/postgresql/data
      - ./scripts/init-postgres.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    
    networks:
      - soc-soar-network
    
    ports:
      - "5433:5432"  # Non-standard port to avoid conflicts
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U soar -d banking_soar"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=1MB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
      - "-c"
      - "logging_collector=on"
      - "-c"
      - "log_directory=/var/log/postgresql"
      - "-c"
      - "log_filename=postgresql-%Y-%m-%d.log"
      - "-c"
      - "log_rotation_age=1d"
      - "-c"
      - "log_line_prefix=%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h "
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis for caching and approval workflow
  soar-redis:
    image: redis:7-alpine
    container_name: banking-soar-redis
    hostname: soar-redis
    restart: unless-stopped
    
    command:
      - "redis-server"
      - "--requirepass"
      - "${REDIS_PASSWORD}"
      - "--maxmemory"
      - "2gb"
      - "--maxmemory-policy"
      - "allkeys-lru"
      - "--appendonly"
      - "yes"
      - "--appendfsync"
      - "everysec"
      - "--save"
      - "900 1"
      - "--save"
      - "300 10"
      - "--save"
      - "60 10000"
    
    volumes:
      - soar-redis-data:/data
    
    networks:
      - soc-soar-network
    
    ports:
      - "6380:6379"  # Non-standard port
    
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # RabbitMQ for message queuing
  soar-rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: banking-soar-rabbitmq
    hostname: soar-rabbitmq
    restart: unless-stopped
    
    environment:
      - RABBITMQ_DEFAULT_USER=soar
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=/soar
      - RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS=-rabbit log_levels [{connection,error},{default,warning}]
    
    volumes:
      - soar-rabbitmq-data:/var/lib/rabbitmq
      - ./config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./config/rabbitmq-definitions.json:/etc/rabbitmq/definitions.json:ro
    
    networks:
      - soc-soar-network
    
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Celery Workers for background tasks
  soar-celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: banking-soar-celery
    hostname: soar-celery
    restart: unless-stopped
    
    command: celery -A src.tasks worker --loglevel=info --concurrency=8 --max-tasks-per-child=50
    
    environment:
      - CELERY_BROKER_URL=amqp://soar:${RABBITMQ_PASSWORD}@soar-rabbitmq:5672//soar
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@soar-redis:6379/1
      - OPENSEARCH_HOSTS=https://wazuh.indexer:9200
      - OPENSEARCH_SOAR_USERNAME=soar
      - OPENSEARCH_SOAR_PASSWORD=${OPENSEARCH_SOAR_PASSWORD}
      - POSTGRES_HOST=soar-postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    
    volumes:
      - ./config:/app/config:ro
      - ./playbooks:/app/playbooks:ro
      - opensearch-certs:/app/certs:ro
    
    networks:
      - soc-soar-network
      - soc-analytics-network
    
    depends_on:
      soar-rabbitmq:
        condition: service_healthy
      soar-redis:
        condition: service_healthy
      soar-postgres:
        condition: service_healthy
    
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  # Celery Beat for scheduled tasks
  soar-celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: banking-soar-beat
    hostname: soar-beat
    restart: unless-stopped
    
    command: celery -A src.tasks beat --loglevel=info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    
    environment:
      - CELERY_BROKER_URL=amqp://soar:${RABBITMQ_PASSWORD}@soar-rabbitmq:5672//soar
      - CELERY_RESULT_BACKEND=redis://:${REDIS_PASSWORD}@soar-redis:6379/1
      - POSTGRES_HOST=soar-postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    
    volumes:
      - ./config:/app/config:ro
    
    networks:
      - soc-soar-network
    
    depends_on:
      soar-rabbitmq:
        condition: service_healthy
      soar-postgres:
        condition: service_healthy
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # Feedback Loop Service
  soar-feedback:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: banking-soar-feedback
    hostname: soar-feedback
    restart: unless-stopped
    
    command: python -m src.services.feedback_loop
    
    environment:
      - OPENSEARCH_HOSTS=https://wazuh.indexer:9200
      - OPENSEARCH_SOAR_USERNAME=soar
      - OPENSEARCH_SOAR_PASSWORD=${OPENSEARCH_SOAR_PASSWORD}
      - REDIS_HOST=soar-redis
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    
    volumes:
      - ./config:/app/config:ro
      - soar-ml-models:/app/models
      - opensearch-certs:/app/certs:ro
    
    networks:
      - soc-soar-network
      - soc-analytics-network
      - soc-ai-network
    
    depends_on:
      soar-redis:
        condition: service_healthy
    
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

volumes:
  soar-postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/soar/postgres
  
  soar-redis-data:
    driver: local
  
  soar-rabbitmq-data:
    driver: local
  
  soar-audit-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/soar/audit-logs
  
  soar-ml-models:
    driver: local
  
  opensearch-certs:
    external: true

networks:
  soc-soar-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.5.0/24
  
  soc-analytics-network:
    external: true
  
  soc-ai-network:
    external: true
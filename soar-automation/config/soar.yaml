# SOAR Automation Configuration
# Enterprise Banking SOC - Zone 2 Security Orchestration, Automation and Response

service:
  name: "banking-soc-soar"
  version: "1.0.0"
  environment: "production"
  api_port: 8200
  metrics_port: 8201
  messaging_port: 9092
  
  health_check:
    enabled: true
    interval_seconds: 30
    timeout_seconds: 10

# OpenSearch connection for incident retrieval
opensearch:
  hosts:
    - "https://wazuh.indexer:9200"
  username: "${OPENSEARCH_SOAR_USERNAME}"
  password: "${OPENSEARCH_SOAR_PASSWORD}"
  verify_certs: true
  ca_certs: "/app/certs/ca.pem"
  indices:
    enriched_incidents: "banking-soc-enriched-incidents"
    executed_actions: "banking-soc-executed-actions"
    feedback: "banking-soc-feedback"
    audit_trail: "banking-soc-audit-trail"
  
  connection:
    timeout: 30
    max_retries: 3
    retry_on_timeout: true

# Redis for approval workflow and caching
redis:
  host: "redis"
  port: 6379
  password: "${REDIS_PASSWORD}"
  db: 0
  ssl: false
  key_prefix: "soar:"
  ttl:
    approval_requests: 3600  # 1 hour
    action_locks: 300  # 5 minutes
    incident_cache: 1800  # 30 minutes

# PostgreSQL for incident state and audit log
postgresql:
  host: "soar-postgres"
  port: 5432
  database: "banking_soar"
  username: "${POSTGRES_USERNAME}"
  password: "${POSTGRES_PASSWORD}"
  pool_size: 20
  max_overflow: 10
  schema: "soar"
  
  tables:
    incidents: "incident_states"
    actions: "action_executions"
    approvals: "approval_workflow"
    audit: "audit_log"

# RabbitMQ for asynchronous task processing
rabbitmq:
  host: "soar-rabbitmq"
  port: 5672
  username: "${RABBITMQ_USERNAME}"
  password: "${RABBITMQ_PASSWORD}"
  vhost: "/soar"
  
  exchanges:
    incidents: "soar.incidents"
    actions: "soar.actions"
    notifications: "soar.notifications"
  
  queues:
    high_priority: "soar.high_priority"
    medium_priority: "soar.medium_priority"
    low_priority: "soar.low_priority"
    notifications: "soar.notifications"

# Action Executors Configuration
action_executors:
  
  # SSH Executor for Linux systems
  ssh:
    enabled: true
    private_key_path: "/app/keys/soar_ssh_key"
    known_hosts_path: "/app/config/known_hosts"
    connection_timeout: 30
    command_timeout: 300
    max_concurrent_connections: 10
    retry_attempts: 2
    
    default_user: "soar_automation"
    sudo_enabled: true
    sudo_password_encrypted: "${SSH_SUDO_PASSWORD_ENC}"
  
  # WinRM Executor for Windows systems
  winrm:
    enabled: true
    auth_method: "kerberos"  # Options: basic, kerberos, ntlm
    transport: "https"
    port: 5986
    connection_timeout: 30
    operation_timeout: 300
    max_concurrent_connections: 10
    
    service_account: "${WINRM_SERVICE_ACCOUNT}"
    service_account_password_encrypted: "${WINRM_PASSWORD_ENC}"
    kerberos_realm: "BANK.INTERNAL"
    kerberos_kdc: "kdc.bank.internal"
  
  # API Integrations
  api:
    
    # Wazuh Manager API
    wazuh:
      enabled: true
      base_url: "https://wazuh.manager:55000"
      username: "${WAZUH_API_USERNAME}"
      password: "${WAZUH_API_PASSWORD}"
      verify_ssl: true
      timeout: 30
      
      actions:
        - "restart_agent"
        - "run_active_response"
        - "update_rules"
        - "create_group"
        - "add_agent_to_group"
    
    # Active Directory
    active_directory:
      enabled: true
      domain: "bank.internal"
      ldap_url: "ldaps://dc.bank.internal:636"
      bind_dn: "${AD_BIND_DN}"
      bind_password_encrypted: "${AD_BIND_PASSWORD_ENC}"
      base_dn: "DC=bank,DC=internal"
      
      actions:
        - "disable_account"
        - "reset_password"
        - "remove_from_group"
        - "revoke_privileges"
        - "expire_password"
        - "lock_account"
    
    # Firewall Management
    firewall:
      enabled: true
      type: "palo_alto"  # Options: palo_alto, fortinet, checkpoint
      base_url: "https://firewall.bank.internal"
      api_key_encrypted: "${FIREWALL_API_KEY_ENC}"
      verify_ssl: true
      
      actions:
        - "block_ip"
        - "block_url"
        - "create_security_rule"
        - "update_address_object"
        - "commit_changes"
    
    # Endpoint Protection (CrowdStrike/Carbon Black/Defender)
    endpoint_protection:
      enabled: true
      platform: "crowdstrike"  # Options: crowdstrike, carbon_black, defender
      base_url: "https://api.crowdstrike.com"
      client_id: "${CROWDSTRIKE_CLIENT_ID}"
      client_secret_encrypted: "${CROWDSTRIKE_SECRET_ENC}"
      
      actions:
        - "isolate_host"
        - "lift_containment"
        - "kill_process"
        - "quarantine_file"
        - "scan_host"
        - "retrieve_file"
    
    # Email Gateway
    email_gateway:
      enabled: true
      type: "proofpoint"  # Options: proofpoint, mimecast
      base_url: "https://tap-api-v2.proofpoint.com"
      principal: "${PROOFPOINT_PRINCIPAL}"
      secret_encrypted: "${PROOFPOINT_SECRET_ENC}"
      
      actions:
        - "block_sender"
        - "quarantine_message"
        - "release_message"
        - "add_to_blocklist"
    
    # Cloud Platforms
    aws:
      enabled: true
      access_key_id: "${AWS_ACCESS_KEY_ID}"
      secret_access_key_encrypted: "${AWS_SECRET_ACCESS_KEY_ENC}"
      region: "us-east-1"
      assume_role_arn: "${AWS_SOC_ROLE_ARN}"
      
      actions:
        - "revoke_iam_session"
        - "rotate_access_key"
        - "terminate_instance"
        - "modify_security_group"
        - "create_snapshot"
        - "enable_cloudtrail"
    
    azure:
      enabled: true
      tenant_id: "${AZURE_TENANT_ID}"
      client_id: "${AZURE_CLIENT_ID}"
      client_secret_encrypted: "${AZURE_CLIENT_SECRET_ENC}"
      subscription_id: "${AZURE_SUBSCRIPTION_ID}"
      
      actions:
        - "revoke_user_session"
        - "disable_user"
        - "isolate_vm"
        - "update_nsg"
        - "enable_diagnostic_logging"
    
    # ServiceNow for ticketing
    servicenow:
      enabled: true
      instance: "bankprod"
      base_url: "https://bankprod.service-now.com"
      username: "${SERVICENOW_USERNAME}"
      password_encrypted: "${SERVICENOW_PASSWORD_ENC}"
      
      actions:
        - "create_incident"
        - "update_incident"
        - "add_work_note"
        - "assign_to_group"
        - "escalate"

# Automation Rules and Policies
automation_rules:
  
  # Priority-based automation policies
  priorities:
    LOW:
      human_review: "optional"
      auto_execute: false
      approval_required: false
      max_impact_score: 3
      actions_allowed:
        - "log_enrichment"
        - "tag_alert"
        - "notify_queue"
        - "create_ticket"
        - "update_knowledge_base"
      
    MEDIUM:
      human_review: "required_before"
      auto_execute: false
      approval_required: true
      approval_timeout_minutes: 60
      max_impact_score: 6
      actions_allowed:
        - "account_lock_temporary"
        - "endpoint_quarantine_warning"
        - "firewall_watch_rule"
        - "email_quarantine"
        - "password_expire"
        - "create_p2_ticket"
      
    HIGH:
      human_review: "required_after"
      auto_execute: true
      approval_required: false
      notification_required: true
      max_impact_score: 8
      actions_allowed:
        - "disable_account"
        - "reset_password"
        - "endpoint_isolation"
        - "ip_block"
        - "url_block"
        - "token_revocation"
        - "terminate_session"
        - "create_p1_ticket"
      
    CRITICAL:
      human_review: "crisis_team"
      auto_execute: true
      approval_required: false
      crisis_activation: true
      max_impact_score: 10
      actions_allowed:
        - "network_segment_isolation"
        - "kill_process"
        - "mass_credential_rotation"
        - "firewall_deny_all"
        - "executive_bridge"
        - "regulator_notification"
        - "forensic_capture"
        - "backup_systems_activate"
  
  # Approval workflow
  approval_workflow:
    enabled: true
    
    approvers:
      tier1:
        - "soc_lead"
        - "security_engineer"
      tier2:
        - "security_manager"
        - "ciso"
      tier3:
        - "ciso"
        - "cto"
        - "ceo"
    
    escalation:
      enabled: true
      tier1_timeout_minutes: 30
      tier2_timeout_minutes: 15
      tier3_timeout_minutes: 10
      
    bypass_conditions:
      - condition: "after_hours_critical"
        priority: "CRITICAL"
        time_window: "22:00-06:00"
        auto_approve: true
      
      - condition: "active_breach"
        priority: "CRITICAL"
        indicators: ["data_exfiltration", "ransomware_detected"]
        auto_approve: true
  
  # Action execution parameters
  execution:
    max_concurrent_actions: 20
    delay_between_actions_seconds: 2
    retry_failed_actions: true
    max_retries: 3
    retry_delay_seconds: 10
    
    rollback:
      enabled: true
      conditions:
        - "action_failure_rate > 0.5"
        - "critical_service_impact"
        - "business_hours AND customer_facing"
      
      actions_with_rollback:
        - "disable_account"
        - "endpoint_isolation"
        - "network_segment_isolation"
        - "firewall_deny_all"
  
  # Impact assessment
  impact_assessment:
    enabled: true
    
    factors:
      - name: "business_criticality"
        weight: 0.3
      - name: "customer_impact"
        weight: 0.3
      - name: "regulatory_exposure"
        weight: 0.2
      - name: "financial_impact"
        weight: 0.2
    
    thresholds:
      low: 3
      medium: 6
      high: 8
      critical: 9

# Notification Configuration
notifications:
  
  # Slack integration
  slack:
    enabled: true
    webhook_url_encrypted: "${SLACK_WEBHOOK_URL_ENC}"
    bot_token_encrypted: "${SLACK_BOT_TOKEN_ENC}"
    
    channels:
      soc_alerts: "#soc-alerts"
      high_priority: "#security-incidents"
      crisis: "#crisis-response"
      approvals: "#soar-approvals"
    
    notification_rules:
      - priority: "LOW"
        channel: "#soc-alerts"
        mention: false
      - priority: "MEDIUM"
        channel: "#soc-alerts"
        mention: "@soc-oncall"
      - priority: "HIGH"
        channel: "#security-incidents"
        mention: "@security-team"
      - priority: "CRITICAL"
        channel: "#crisis-response"
        mention: "@channel"
  
  # Email notifications
  email:
    enabled: true
    smtp_server: "smtp.bank.internal"
    smtp_port: 587
    username: "${SMTP_USERNAME}"
    password_encrypted: "${SMTP_PASSWORD_ENC}"
    from_address: "soc-soar@bank.com"
    use_tls: true
    
    distribution_lists:
      soc_team: "soc-team@bank.com"
      security_managers: "security-managers@bank.com"
      executives: "security-executives@bank.com"
      board: "board-security@bank.com"
      compliance: "compliance-team@bank.com"
  
  # SMS/Phone (Twilio)
  sms:
    enabled: true
    provider: "twilio"
    account_sid: "${TWILIO_ACCOUNT_SID}"
    auth_token_encrypted: "${TWILIO_AUTH_TOKEN_ENC}"
    from_number: "+1234567890"
    
    on_call_rotation:
      primary: "+1234567891"
      secondary: "+1234567892"
      manager: "+1234567893"
      ciso: "+1234567894"
  
  # Phone call (PagerDuty)
  pagerduty:
    enabled: true
    api_key_encrypted: "${PAGERDUTY_API_KEY_ENC}"
    
    services:
      soc: "PSOC123"
      security_engineering: "PSE456"
      crisis_team: "PCRISIS789"
    
    escalation_policy:
      level1: "soc"
      level2: "security_engineering"
      level3: "crisis_team"

# Feedback Loop and Continuous Learning
feedback:
  enabled: true
  
  collection_methods:
    - "analyst_explicit_feedback"
    - "playbook_effectiveness_rating"
    - "action_outcome_tracking"
    - "false_positive_reporting"
    - "incident_resolution_metrics"
  
  learning_frequency:
    model_retraining_days: 7
    baseline_update_hours: 24
    rule_tuning_days: 14
  
  improvements:
    - target: "ueba_baselines"
      method: "incremental_learning"
      threshold: "100_new_samples"
    
    - target: "wazuh_rules"
      method: "threshold_adjustment"
      threshold: "10_false_positives"
    
    - target: "llm_prompts"
      method: "fine_tuning"
      threshold: "50_feedback_samples"
    
    - target: "playbook_library"
      method: "versioning_and_improvement"
      threshold: "5_ineffective_ratings"
  
  metrics:
    - "false_positive_rate"
    - "true_positive_rate"
    - "mean_time_to_detect"
    - "mean_time_to_respond"
    - "mean_time_to_resolve"
    - "playbook_effectiveness_score"
    - "automation_coverage_percentage"
    - "analyst_satisfaction_score"

# Audit and Compliance
audit:
  enabled: true
  
  database:
    type: "postgresql"
    retention_days: 2555  # 7 years for regulatory compliance
    compression: true
    encryption_at_rest: true
  
  compliance_frameworks:
    - "PCI-DSS"
    - "SOX"
    - "GDPR"
    - "Basel III"
    - "FFIEC"
  
  logged_events:
    - "action_execution"
    - "approval_request"
    - "approval_decision"
    - "playbook_generation"
    - "rule_modification"
    - "configuration_change"
    - "user_authentication"
    - "data_access"
  
  fields:
    required:
      - "timestamp"
      - "user_id"
      - "action_type"
      - "target_system"
      - "outcome"
      - "incident_id"
    optional:
      - "justification"
      - "approval_chain"
      - "rollback_plan"
      - "business_impact"
  
  reporting:
    enabled: true
    schedules:
      daily: "08:00"
      weekly: "MON 09:00"
      monthly: "1st 10:00"
    
    recipients:
      - "compliance@bank.com"
      - "audit@bank.com"
      - "ciso@bank.com"

# Playbook Management
playbooks:
  storage_path: "/app/playbooks"
  versioning: true
  
  categories:
    - "account_compromise"
    - "malware_infection"
    - "data_exfiltration"
    - "insider_threat"
    - "phishing_campaign"
    - "ransomware"
    - "ddos_attack"
    - "unauthorized_access"
    - "privilege_escalation"
    - "supply_chain_compromise"
  
  templates:
    - "incident_analysis"
    - "containment_procedures"
    - "eradication_steps"
    - "recovery_plan"
    - "post_incident_review"
  
  auto_generation:
    enabled: true
    llm_service: "enrichment:8300"
    fallback_to_template: true
    human_review_required: false

# Performance and Monitoring
monitoring:
  metrics_enabled: true
  prometheus_port: 8201
  
  metrics:
    - "incidents_processed_total"
    - "actions_executed_total"
    - "actions_failed_total"
    - "approval_requests_total"
    - "approval_timeout_total"
    - "playbook_generation_duration"
    - "action_execution_duration"
    - "incident_resolution_duration"
  
  logging:
    level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
    format: "json"
    output: "stdout"
    
    file_logging:
      enabled: true
      path: "/var/log/soar"
      max_size_mb: 100
      backup_count: 10
      rotation: "daily"

# Security Settings
security:
  encryption:
    algorithm: "AES-256-GCM"
    key_rotation_days: 90
  
  authentication:
    method: "jwt"
    token_expiry_hours: 8
    refresh_token_expiry_days: 30
  
  authorization:
    rbac_enabled: true
    roles:
      - name: "soc_analyst"
        permissions: ["view_incidents", "request_approval", "provide_feedback"]
      - name: "soc_lead"
        permissions: ["view_incidents", "approve_medium", "execute_actions", "tune_rules"]
      - name: "security_manager"
        permissions: ["view_incidents", "approve_high", "execute_actions", "modify_playbooks"]
      - name: "ciso"
        permissions: ["full_access"]
  
  rate_limiting:
    enabled: true
    requests_per_minute: 100
    burst: 150
  
  ip_whitelist:
    enabled: true
    allowed_ranges:
      - "10.0.0.0/8"
      - "172.16.0.0/12"
  
  api_keys:
    rotation_days: 90
    encryption: true
    storage: "vault"

# Integration with other SOC components
integrations:
  vector_etl:
    host: "vector"
    port: 8686
  
  wazuh_manager:
    host: "wazuh.manager"
    port: 55000
  
  opensearch:
    host: "wazuh.indexer"
    port: 9200
  
  ai_intelligence:
    host: "ai-intelligence"
    port: 8100
  
  enrichment:
    host: "enrichment"
    port: 8300
  
  neo4j:
    host: "neo4j"
    port: 7687
# Enrichment Service Configuration
# Enterprise Banking SOC - Threat Intelligence and LLM Integration

service:
  name: "banking-soc-enrichment"
  version: "1.0.0"
  environment: "production"
  api_port: 8100
  admin_port: 8101
  metrics_port: 9091

# Data Sources
data_sources:
  opensearch:
    hosts: ["opensearch.analytics:9200"]
    username: "enrichment_user"
    password: "${OPENSEARCH_ENRICHMENT_PASSWORD}"
    use_ssl: true
    verify_certs: false
    
  redis:
    host: "redis.cache"
    port: 6379
    password: "${REDIS_PASSWORD}"
    db: 2
    
  wazuh_api:
    url: "https://wazuh.manager:55000"
    username: "${WAZUH_API_USER}"
    password: "${WAZUH_API_PASSWORD}"

# CVE Enrichment
cve_enrichment:
  enabled: true
  data_sources:
    - nvd  # National Vulnerability Database
    - exploitdb  # Exploit Database
    - cisa_kev  # CISA Known Exploited Vulnerabilities
  
  nvd:
    api_key: "${NVD_API_KEY}"
    api_url: "https://services.nvd.nist.gov/rest/json/cves/2.0"
    rate_limit_requests_per_minute: 5
    cache_ttl_hours: 24
  
  exploitdb:
    api_url: "https://www.exploit-db.com/api/v1"
    update_frequency_hours: 24
    cache_ttl_hours: 168  # 1 week
  
  cisa_kev:
    catalog_url: "https://www.cisa.gov/sites/default/files/feeds/known_exploited_vulnerabilities.json"
    update_frequency_hours: 12
  
  scoring:
    cvss_critical_threshold: 9.0
    cvss_high_threshold: 7.0
    cvss_medium_threshold: 4.0
    exploit_available_weight: 2.0
    known_exploited_weight: 3.0

# Threat Intelligence
threat_intelligence:
  enabled: true
  
  # MISP (Malware Information Sharing Platform)
  misp:
    enabled: true
    url: "${MISP_URL}"
    api_key: "${MISP_API_KEY}"
    verify_ssl: false
    tag_filters: ["banker", "apt", "ransomware"]
    update_frequency_minutes: 30
  
  # OpenCTI (Open Cyber Threat Intelligence)
  opencti:
    enabled: true
    url: "${OPENCTI_URL}"
    api_key: "${OPENCTI_API_KEY}"
    update_frequency_minutes: 30
    confidence_threshold: 70
  
  # AlienVault OTX
  otx:
    enabled: true
    api_key: "${OTX_API_KEY}"
    pulse_subscriptions: ["financial", "banking", "apt"]
    update_frequency_minutes: 60
  
  # Custom threat feeds
  custom_feeds:
    - name: "banking_sector_threats"
      url: "${CUSTOM_FEED_URL}"
      format: "stix2"
      authentication: "bearer_token"
      update_frequency_minutes: 60
  
  # IOC matching
  ioc_matching:
    match_types: ["ip", "domain", "hash", "email", "url"]
    confidence_threshold: 0.6
    max_age_days: 90

# MITRE ATT&CK
mitre_attack:
  enabled: true
  data_source: "https://raw.githubusercontent.com/mitre/cti/master/enterprise-attack/enterprise-attack.json"
  update_frequency_hours: 168  # Weekly
  
  technique_mapping:
    auto_map_from_keywords: true
    keyword_confidence_threshold: 0.7
  
  context_enrichment:
    include_tactics: true
    include_techniques: true
    include_sub_techniques: true
    include_procedures: true
    include_mitigations: true
    include_detections: true
    include_threat_actors: true
  
  banking_specific_techniques:
    high_priority:
      - "T1078"  # Valid Accounts
      - "T1190"  # Exploit Public-Facing Application
      - "T1566"  # Phishing
      - "T1486"  # Data Encrypted for Impact (Ransomware)
      - "T1657"  # Financial Theft

# Asset Criticality
asset_criticality:
  enabled: true
  
  # Asset database source
  cmdb:
    enabled: true
    api_url: "${CMDB_API_URL}"
    api_key: "${CMDB_API_KEY}"
    cache_ttl_hours: 6
  
  # Criticality scoring (0-10 scale)
  scoring_rules:
    asset_types:
      payment_gateway: 10
      core_banking_system: 10
      database_server: 9
      authentication_server: 9
      web_application: 7
      workstation: 5
      network_device: 7
      
    business_functions:
      payment_processing: 10
      customer_data: 9
      financial_reporting: 9
      internal_operations: 6
      
    data_classification:
      confidential: 9
      internal: 6
      public: 3
    
    compliance_scope:
      pci_dss: 9
      sox: 8
      basel_iii: 8
      
  multipliers:
    production_environment: 1.5
    customer_facing: 1.3
    internet_exposed: 1.2
  
  # Impact assessment
  impact_categories:
    - financial_loss
    - operational_disruption
    - regulatory_penalty
    - reputational_damage
    - customer_impact

# LLM Configuration
llm:
  mode: "hybrid"  # Options: on_premises, cloud, hybrid
  
  # On-premises models
  on_premises:
    enabled: true
    model: "meta-llama/Llama-2-13b-chat-hf"  # or "mistralai/Mistral-7B-Instruct-v0.2"
    device: "cuda"  # or "cpu"
    quantization: "8bit"  # Options: none, 8bit, 4bit
    max_memory_gb: 16
    
  # Cloud APIs
  cloud:
    enabled: true
    primary_provider: "openai"  # Options: openai, anthropic
    
    openai:
      model: "gpt-4o"
      api_key: "${OPENAI_API_KEY}"
      max_tokens: 4000
      temperature: 0.3
      organization: "${OPENAI_ORG_ID}"
      
    anthropic:
      model: "claude-3-opus-20240229"
      api_key: "${ANTHROPIC_API_KEY}"
      max_tokens: 4000
      temperature: 0.3
  
  # Prompt engineering
  prompts:
    directory: "/app/prompts"
    templates:
      - incident_analysis
      - playbook_generation
      - executive_summary
      - technical_details
      - soar_actions
    
    banking_context:
      include_compliance_requirements: true
      include_regulatory_considerations: true
      include_business_impact_analysis: true
      financial_institution_type: "enterprise_bank"
  
  # Fine-tuning
  fine_tuning:
    enabled: false
    dataset_path: "/app/data/fine_tuning"
    update_frequency: "monthly"
    effectiveness_tracking: true
  
  # Quality and safety
  quality_control:
    fact_checking: true
    hallucination_detection: true
    compliance_validation: true
    human_review_threshold: 0.7  # Low confidence triggers review
  
  # Performance
  performance:
    caching_enabled: true
    cache_ttl_hours: 24
    batch_processing: true
    max_concurrent_requests: 5
    timeout_seconds: 120

# Enrichment Orchestration
orchestration:
  processing:
    batch_size: 10
    processing_interval_seconds: 30
    max_retries: 3
    retry_delay_seconds: 5
  
  pipeline_stages:
    - stage: "cve_lookup"
      timeout_seconds: 30
      required: false
      
    - stage: "threat_intel_matching"
      timeout_seconds: 60
      required: false
      
    - stage: "mitre_mapping"
      timeout_seconds: 20
      required: true
      
    - stage: "asset_criticality"
      timeout_seconds: 15
      required: true
      
    - stage: "llm_playbook_generation"
      timeout_seconds: 120
      required: true
      fallback: "template_based"
  
  output:
    opensearch_index: "banking-soc-enriched-incidents"
    kafka_topic: "soc.enriched.incidents"
    webhook_url: "${SOAR_WEBHOOK_URL}"

# Logging and Monitoring
logging:
  level: "INFO"
  format: "structured"
  handlers:
    - type: "console"
    - type: "file"
      filename: "/app/logs/enrichment.log"
      max_size: "100MB"
      backup_count: 10
    - type: "syslog"
      address: "syslog.banking-soc.internal"

monitoring:
  metrics:
    enabled: true
    export_interval_seconds: 30
    
  health_checks:
    enabled: true
    interval_seconds: 30
    
  performance_tracking:
    enrichment_latency: true
    llm_generation_time: true
    api_response_times: true
    cache_hit_rate: true

# Security
security:
  authentication:
    enabled: true
    method: "jwt"
    
  api_keys:
    rotation_days: 90
    
  data_protection:
    encrypt_sensitive_fields: true
    pii_redaction: true
    
  audit:
    log_all_enrichment_activities: true
    log_llm_prompts_and_responses: true
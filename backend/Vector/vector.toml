data_dir = "/var/lib/vector"

[enrichment_tables.geoip_mmdb]
type = "geoip"
path = "/etc/vector/enrichment/GeoLite2-City.mmdb"

[enrichment_tables.geoip_csv]
type = "file"
file.path = "/etc/vector/enrichment/geoip.csv"
file.encoding.type = "csv"

[enrichment_tables.threat_intel]
type = "file"
file.path = "/etc/vector/enrichment/threat_intel.csv"
file.encoding.type = "csv"

[enrichment_tables.user_identity]
type = "file"
file.path = "/etc/vector/enrichment/user_identity.csv"
file.encoding.type = "csv"

[sources.core_banking]
type = "file"
include = ["/logs/core_banking.jsonl"]
read_from = "beginning"

[sources.api_web_json]
type = "file"
include = ["/logs/api_web.jsonl"]
read_from = "beginning"

[sources.api_web_cef]
type = "file"
include = ["/logs/api_web.cef"]
read_from = "beginning"

[sources.databases]
type = "file"
include = ["/logs/databases.jsonl"]
read_from = "beginning"

[sources.linux_syslog]
type = "file"
include = ["/logs/linux_syslog.log"]
read_from = "beginning"

# Firewall / IDS logs (CEF or JSON)
[sources.firewall_cef]
type = "file"
include = ["/logs/firewall_ids.cef"]
read_from = "beginning"

[sources.firewall_json]
type = "file"
include = ["/logs/firewall_ids.jsonl"]
read_from = "beginning"

# VPN auth logs (syslog format)
[sources.vpn_syslog]
type = "file"
include = ["/logs/vpn_auth.log"]
read_from = "beginning"

# Cloud logs (file-based for testing)
[sources.aws_cloudtrail_file]
type = "file"
include = ["/logs/aws_cloudtrail.jsonl"]
read_from = "beginning"

[sources.azure_activity_file]
type = "file"
include = ["/logs/azure_activity.jsonl"]
read_from = "beginning"

[sources.gcp_audit_file]
type = "file"
include = ["/logs/gcp_audit.jsonl"]
read_from = "beginning"

# Mainframe (z/OS) converted JSON
[sources.mainframe_zos]
type = "file"
include = ["/logs/mainframe_zos.jsonl"]
read_from = "beginning"

# Cloud sources (templates) â€” uncomment and set credentials/queues when ready
# [sources.aws_cloudtrail]
# type = "aws_s3"
# bucket = "REPLACE_ME"
# region = "us-east-1"
# compression = "auto"
# sqs.queue_url = "REPLACE_ME"
# sqs.polling.wait_time_seconds = 20
# sqs.polling.max_number_of_messages = 10
# sqs.visibility_timeout_secs = 300
#
# [sources.azure_activity]
# type = "http_server"
# address = "0.0.0.0:8088"
#
# [sources.gcp_audit]
# type = "gcp_pubsub"
# project = "REPLACE_ME"
# subscription = "REPLACE_ME"

[sources.windows_events]
type = "file"
include = ["/logs/windows_events.xml"]
read_from = "beginning"

[sources.active_directory]
type = "file"
include = ["/logs/active_directory.xml"]
read_from = "beginning"

[transforms.core_banking_parse]
type = "remap"
inputs = ["core_banking"]
source = """
. = parse_json!(.message)
"""

[transforms.core_banking_norm]
type = "remap"
inputs = ["core_banking_parse"]
source = """
.@timestamp = parse_timestamp!(.timestamp, "%+")
.event.kind = "event"
.event.category = ["financial"]
.event.action = .action
.event.type = [string!(.event_type)]
.event.dataset = "core_banking"
.ecs.version = "8.11.0"
.source.ip = .src_ip
.destination.ip = .dest_ip
.user.name = .user
.host.hostname = .host
.log.level = .level
"""

[transforms.api_web_json_parse]
type = "remap"
inputs = ["api_web_json"]
source = """
. = parse_json!(.message)
"""

[transforms.api_web_json_norm]
type = "remap"
inputs = ["api_web_json_parse"]
source = """
.@timestamp = parse_timestamp!(.timestamp, "%+")
.event.kind = "event"
.event.category = ["web"]
.event.action = .action
.event.type = [string!(.event_type)]
.event.dataset = "api_web"
.ecs.version = "8.11.0"
.source.ip = .src_ip
.destination.ip = .dest_ip
.user.name = .user
.http.request.method = .method
.url.path = .path
.http.response.status_code = .status
.user_agent.original = .user_agent
.network.bytes = .bytes
.log.level = .level
"""

[transforms.api_web_cef_parse]
type = "remap"
inputs = ["api_web_cef"]
source = """
. = parse_cef!(.message)
"""

[transforms.api_web_cef_norm]
type = "remap"
inputs = ["api_web_cef_parse"]
source = """
.@timestamp = now()
.event.kind = "event"
.event.category = ["web"]
.event.action = .name
.event.type = ["cef"]
.event.dataset = "api_web"
.ecs.version = "8.11.0"
src_ip, src_err = get(.extensions, ["src"])
dst_ip, dst_err = get(.extensions, ["dst"])
req_method, req_err = get(.extensions, ["requestMethod"])
req_path, path_err = get(.extensions, ["request"])
if src_err == null { .source.ip = to_string!(src_ip) }
if dst_err == null { .destination.ip = to_string!(dst_ip) }
if req_err == null { .http.request.method = to_string!(req_method) }
if path_err == null { .url.path = to_string!(req_path) }
sev, sev_err = to_int(.severity)
if sev_err != null { sev = 0 }
.log.level = if sev >= 7 { "warning" } else { "info" }
"""

[transforms.databases_parse]
type = "remap"
inputs = ["databases"]
source = """
. = parse_json!(.message)
"""

[transforms.databases_norm]
type = "remap"
inputs = ["databases_parse"]
source = """
.@timestamp = parse_timestamp!(.timestamp, "%+")
.event.kind = "event"
.event.category = ["database"]
.event.action = .action
.event.type = [string!(.event_type)]
.event.dataset = "databases"
.ecs.version = "8.11.0"
.source.ip = .src_ip
.destination.ip = .dest_ip
.user.name = .user
.db.name = .database
.db.schema = .schema
.db.table = .table
.log.level = .level
"""

[transforms.linux_syslog_parse]
type = "remap"
inputs = ["linux_syslog"]
source = """
parsed = parse_syslog!(.message)
. = parsed
.message = parsed.msg
"""

[transforms.linux_syslog_norm]
type = "remap"
inputs = ["linux_syslog_parse"]
source = """
if is_timestamp(.timestamp) {
	.@timestamp = .timestamp
} else {
	.@timestamp = parse_timestamp!(.timestamp, "%+")
}
.event.kind = "event"
.event.category = ["host"]
.event.action = .appname
.event.type = ["syslog"]
.event.dataset = "linux_syslog"
.ecs.version = "8.11.0"
.host.hostname = .hostname
.process.name = .appname
if !exists(.source.ip) { .source.ip = "127.0.0.1" }
.log.level = "info"
"""

[transforms.firewall_cef_parse]
type = "remap"
inputs = ["firewall_cef"]
source = """
. = parse_cef!(.message)
"""

[transforms.firewall_cef_norm]
type = "remap"
inputs = ["firewall_cef_parse"]
source = """
.@timestamp = now()
.event.kind = "event"
.event.category = ["network", "intrusion_detection"]
.event.action = .name
.event.type = ["cef"]
.event.dataset = "firewall_ids"
.ecs.version = "8.11.0"
src_ip, src_err = get(.extensions, ["src"])
dst_ip, dst_err = get(.extensions, ["dst"])
if src_err == null { .source.ip = to_string!(src_ip) }
if dst_err == null { .destination.ip = to_string!(dst_ip) }
.log.level = "warning"
"""

[transforms.firewall_json_parse]
type = "remap"
inputs = ["firewall_json"]
source = """
. = parse_json!(.message)
"""

[transforms.firewall_json_norm]
type = "remap"
inputs = ["firewall_json_parse"]
source = """
.@timestamp = parse_timestamp!(.timestamp, "%+")
.event.kind = "event"
.event.category = ["network", "intrusion_detection"]
.event.action = .action
.event.type = [string!(.event_type)]
.event.dataset = "firewall_ids"
.ecs.version = "8.11.0"
.source.ip = .src_ip
.destination.ip = .dest_ip
.user.name = .user
.log.level = .level
"""

[transforms.vpn_syslog_parse]
type = "remap"
inputs = ["vpn_syslog"]
source = """
parsed = parse_syslog!(.message)
. = parsed
.message = parsed.msg
"""

[transforms.vpn_syslog_norm]
type = "remap"
inputs = ["vpn_syslog_parse"]
source = """
if is_timestamp(.timestamp) {
	.@timestamp = .timestamp
} else {
	.@timestamp = parse_timestamp!(.timestamp, "%+")
}
.event.kind = "event"
.event.category = ["authentication", "network"]
.event.action = .appname
.event.type = ["syslog"]
.event.dataset = "vpn_auth"
.ecs.version = "8.11.0"
.host.hostname = .hostname
.process.name = .appname
if !exists(.source.ip) { .source.ip = "127.0.0.1" }
.log.level = "info"
"""

[transforms.aws_cloudtrail_parse]
type = "remap"
inputs = ["aws_cloudtrail_file"]
source = """
. = parse_json!(.message)
"""

[transforms.aws_cloudtrail_norm]
type = "remap"
inputs = ["aws_cloudtrail_parse"]
source = """
.@timestamp = parse_timestamp!(.timestamp, "%+")
.event.kind = "event"
.event.category = ["cloud"]
.event.action = .action
.event.type = [string!(.event_type)]
.event.dataset = "aws_cloudtrail"
.ecs.version = "8.11.0"
.source.ip = .src_ip
.user.name = .user
.cloud.provider = "aws"
.cloud.region = .region
.log.level = .level
"""

[transforms.azure_activity_parse]
type = "remap"
inputs = ["azure_activity_file"]
source = """
. = parse_json!(.message)
"""

[transforms.azure_activity_norm]
type = "remap"
inputs = ["azure_activity_parse"]
source = """
.@timestamp = parse_timestamp!(.timestamp, "%+")
.event.kind = "event"
.event.category = ["cloud"]
.event.action = .action
.event.type = [string!(.event_type)]
.event.dataset = "azure_activity"
.ecs.version = "8.11.0"
.source.ip = .src_ip
.user.name = .user
.cloud.provider = "azure"
.cloud.region = .region
.log.level = .level
"""

[transforms.gcp_audit_parse]
type = "remap"
inputs = ["gcp_audit_file"]
source = """
. = parse_json!(.message)
"""

[transforms.gcp_audit_norm]
type = "remap"
inputs = ["gcp_audit_parse"]
source = """
.@timestamp = parse_timestamp!(.timestamp, "%+")
.event.kind = "event"
.event.category = ["cloud"]
.event.action = .action
.event.type = [string!(.event_type)]
.event.dataset = "gcp_audit"
.ecs.version = "8.11.0"
.source.ip = .src_ip
.user.name = .user
.cloud.provider = "gcp"
.cloud.region = .region
.log.level = .level
"""

[transforms.mainframe_parse]
type = "remap"
inputs = ["mainframe_zos"]
source = """
. = parse_json!(.message)
"""

[transforms.mainframe_norm]
type = "remap"
inputs = ["mainframe_parse"]
source = """
.@timestamp = parse_timestamp!(.timestamp, "%+")
.event.kind = "event"
.event.category = ["host", "audit"]
.event.action = .action
.event.type = [string!(.event_type)]
.event.dataset = "mainframe_zos"
.ecs.version = "8.11.0"
.source.ip = .src_ip
.user.name = .user
.log.level = .level
"""

[transforms.windows_xml_parse]
type = "remap"
inputs = ["windows_events"]
source = """
.xml = parse_xml!(.message)
"""

[transforms.windows_xml_norm]
type = "remap"
inputs = ["windows_xml_parse"]
source = """
.@timestamp = parse_timestamp!(.xml.Event.System.TimeCreated, "%+")
.event.kind = "event"
.event.category = ["authentication", "host"]
.event.action = .xml.Event.EventData.Action
.event.type = ["windows"]
.event.dataset = "windows_security"
.ecs.version = "8.11.0"
.event.code = to_int!(.xml.Event.System.EventID)
.host.hostname = .xml.Event.System.Computer
.user.name = .xml.Event.EventData.TargetUserName
.source.ip = .xml.Event.EventData.IpAddress
.event.outcome = .xml.Event.EventData.Status
"""

[transforms.ad_xml_parse]
type = "remap"
inputs = ["active_directory"]
source = """
.xml = parse_xml!(.message)
"""

[transforms.ad_xml_norm]
type = "remap"
inputs = ["ad_xml_parse"]
source = """
.@timestamp = parse_timestamp!(.xml.Event.System.TimeCreated, "%+")
.event.kind = "event"
.event.category = ["iam"]
.event.action = .xml.Event.EventData.Action
.event.type = ["windows"]
.event.dataset = "active_directory"
.ecs.version = "8.11.0"
.event.code = to_int!(.xml.Event.System.EventID)
.host.hostname = .xml.Event.System.Computer
.user.name = .xml.Event.EventData.TargetUserName
.source.ip = .xml.Event.EventData.IpAddress
.event.outcome = .xml.Event.EventData.Status
"""

[transforms.enrich]
type = "remap"
inputs = [
	"core_banking_norm",
	"api_web_json_norm",
	"api_web_cef_norm",
	"databases_norm",
	"linux_syslog_norm",
	"windows_xml_norm",
	"ad_xml_norm",
	"firewall_cef_norm",
	"firewall_json_norm",
	"vpn_syslog_norm",
	"aws_cloudtrail_norm",
	"azure_activity_norm",
	"gcp_audit_norm",
	"mainframe_norm",
]
source = """
geo_mmdb, geo_mmdb_err = get_enrichment_table_record("geoip_mmdb", {"ip": .source.ip})
if geo_mmdb_err == null && geo_mmdb != null {
	.geo = geo_mmdb
} else {
	geo_csv, geo_csv_err = get_enrichment_table_record("geoip_csv", {"ip": .source.ip})
	if geo_csv_err == null && geo_csv != null {
		.geo = {
			"country_name": geo_csv.country,
			"city_name": geo_csv.city,
			"location": {"lat": geo_csv.lat, "lon": geo_csv.lon}
		}
	}
}

ti, ti_err = get_enrichment_table_record("threat_intel", {"ip": .source.ip})
if ti_err == null && ti != null {
	.threat = {
		"indicator": {
			"type": "ipv4-addr",
			"ip": .source.ip,
			"name": ti.threat_type
		},
		"confidence": ti.confidence,
		"feed": {"name": ti.source}
	}
}

if exists(.user) && exists(.user.name) && !is_null(.user.name) && .user.name != "" {
	user_identity, user_identity_err = get_enrichment_table_record("user_identity", {"user_name": .user.name})
	if user_identity_err == null && user_identity != null && !is_null(user_identity.user_id) && user_identity.user_id != "" {
		.user.id = user_identity.user_id
	} else {
		.user.id = "UNKNOWN-" + string!(.user.name)
	}
}
"""

[transforms.schema_route]
type = "route"
inputs = ["enrich"]
route.valid = 'exists(.@timestamp) && exists(.event.kind) && exists(.source.ip)'
route.invalid = '!exists(.@timestamp) || !exists(.event.kind) || !exists(.source.ip)'

[sinks.clean_output]
type = "file"
inputs = ["schema_route.valid"]
path = "/vector-output/clean.json"
encoding.codec = "json"

[sinks.quarantine_output]
type = "file"
inputs = ["schema_route.invalid"]
path = "/vector-output/quarantine.json"
encoding.codec = "json"
